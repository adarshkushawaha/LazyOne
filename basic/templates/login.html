<!DOCTYPE html>
<html>
<head>
    <title>Login or Sign Up</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-container { width: 320px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; cursor: pointer; margin-top: 5px; }
        .signup-button { background-color: #28a745; color: white; }
        .signin-button { background-color: #007bff; color: white; }
        .google-button { background-color: #db4437; color: white; margin-top: 15px; }
        #error-message { color: red; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="login-container">
    <h2>Welcome</h2>
    <p>Sign in or create an account</p>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    
    <button id="signup-button" class="signup-button">Create Account</button>
    <button id="signin-button" class="signin-button">Sign In</button>
    
    <hr style="margin-top: 20px;">

    <button id="google-signin-button" class="google-button">Sign In with Google</button>
    <div id="error-message"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script>
    // Securely initialize Firebase from backend context
    var firebaseConfig = {
        apiKey: "{{ FIREBASE_API_KEY }}",
        authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
        projectId: "{{ FIREBASE_PROJECT_ID }}",
        storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
        messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID }}",
        appId: "{{ FIREBASE_APP_ID }}"
    };

    // --- DEBUGGING STEP ---
    console.log("Firebase Config Received by Template:", firebaseConfig);
    // --- END DEBUGGING STEP ---

    if (!firebaseConfig.apiKey) {
        document.getElementById('error-message').textContent = 'CRITICAL ERROR: Firebase API Key is missing. Check Django settings and .env file.';
    } else if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    } else {
        firebase.app();
    }

    const signupButton = document.getElementById('signup-button');
    const signinButton = document.getElementById('signin-button');
    const googleSigninButton = document.getElementById('google-signin-button');
    const errorMessageDiv = document.getElementById('error-message');

    // Function to send token to our Django backend
    function sendTokenToBackend(idToken) {
        fetch('{% url "firebase_login" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token: idToken })
        }).then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  window.location.href = "{% url 'home' %}"; // Redirect to home on success
              } else {
                  errorMessageDiv.textContent = 'Backend login failed: ' + data.message;
              }
          }).catch(error => {
              errorMessageDiv.textContent = 'An error occurred while communicating with the server.';
          });
    }

    // Sign Up with Email/Password
    signupButton.addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        errorMessageDiv.textContent = '';

        firebase.auth().createUserWithEmailAndPassword(email, password)
            .then(userCredential => userCredential.user.getIdToken())
            .then(idToken => sendTokenToBackend(idToken))
            .catch(error => {
                errorMessageDiv.textContent = error.message;
            });
    });

    // Sign In with Email/Password
    signinButton.addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        errorMessageDiv.textContent = '';

        firebase.auth().signInWithEmailAndPassword(email, password)
            .then(userCredential => userCredential.user.getIdToken())
            .then(idToken => sendTokenToBackend(idToken))
            .catch(error => {
                if (error.code === 'auth/user-not-found') {
                    errorMessageDiv.textContent = "No account found with this email. Please create an account.";
                } else {
                    errorMessageDiv.textContent = error.message;
                }
            });
    });

    // Google Sign In
    googleSigninButton.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        errorMessageDiv.textContent = '';

        firebase.auth().signInWithPopup(provider)
            .then(result => result.user.getIdToken())
            .then(idToken => sendTokenToBackend(idToken))
            .catch(error => {
                errorMessageDiv.textContent = error.message;
            });
    });

</script>

</body>
</html>
