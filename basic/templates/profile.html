{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-white mb-8 text-center">Edit Your Profile</h2>

<form method="post" class="space-y-6 max-w-2xl mx-auto">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="first_name" class="block text-sm font-medium text-gray-300 mb-2">First Name</label>
            <input type="text" id="first_name" name="first_name" value="{{ profile.first_name }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
        <div>
            <label for="last_name" class="block text-sm font-medium text-gray-300 mb-2">Last Name</label>
            <input type="text" id="last_name" name="last_name" value="{{ profile.last_name }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
    </div>

    <div>
        <label for="bio" class="block text-sm font-medium text-gray-300 mb-2">Bio</label>
        <textarea id="bio" name="bio" rows="3" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">{{ profile.bio }}</textarea>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="college" class="block text-sm font-medium text-gray-300 mb-2">College</label>
            <input type="text" id="college" name="college" value="{{ profile.college }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
        <div>
            <label for="major" class="block text-sm font-medium text-gray-300 mb-2">Major</label>
            <input type="text" id="major" name="major" value="{{ profile.major }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
        <div>
            <label for="roll_no" class="block text-sm font-medium text-gray-300 mb-2">Roll Number</label>
            <input type="text" id="roll_no" name="roll_no" value="{{ profile.roll_no }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
        <div>
            <label for="batch" class="block text-sm font-medium text-gray-300 mb-2">Batch</label>
            <input type="number" id="batch" name="batch" value="{{ profile.batch }}" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
        </div>
    </div>

    <div>
        <label for="phone_number" class="block text-sm font-medium text-gray-300 mb-2">Phone Number</label>
        <div class="flex items-center space-x-4">
            <input type="text" id="phone_number" name="phone_number" value="{{ profile.phone_number }}" placeholder="+91..." class="flex-grow w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
            {% if profile.is_phone_verified %}
                <span class="text-green-400 font-semibold flex items-center whitespace-nowrap">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Verified
                </span>
            {% else %}
                <button type="button" id="verify-phone-button" class="px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors whitespace-nowrap">Verify</button>
            {% endif %}
        </div>
        <div id="recaptcha-container" class="mt-2"></div>
        <div id="phone-verification-code-group" style="display: none;" class="mt-4 flex items-center space-x-4">
            <input type="text" id="phone-verification-code" placeholder="Enter verification code" class="flex-grow w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
            <button type="button" id="submit-verification-code" class="px-5 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors whitespace-nowrap">Submit</button>
        </div>
    </div>

    <div>
        <label for="instagram_username" class="block text-sm font-medium text-gray-300 mb-2">Instagram Username</label>
        <input type="text" id="instagram_username" name="instagram_username" value="{{ profile.instagram_username }}" placeholder="your_insta_handle" class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
    </div>

    <div class="pt-6">
        <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg bg-cyan-500 hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-cyan-500 transition-all duration-300 transform hover:scale-105">
            Update Profile
        </button>
    </div>
</form>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "{{ FIREBASE_API_KEY|default:'' }}",
        authDomain: "{{ FIREBASE_AUTH_DOMAIN|default:'' }}",
        projectId: "{{ FIREBASE_PROJECT_ID|default:'' }}",
        storageBucket: "{{ FIREBASE_STORAGE_BUCKET|default:'' }}",
        messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID|default:'' }}",
        appId: "{{ FIREBASE_APP_ID|default:'' }}"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    } else {
        firebase.app();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const verifyPhoneButton = document.getElementById('verify-phone-button');
        if (verifyPhoneButton) {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible'
            });

            verifyPhoneButton.addEventListener('click', () => {
                const phoneNumber = document.getElementById('phone_number').value;
                if (!phoneNumber) {
                    alert('Please enter a phone number first.');
                    return;
                }

                const appVerifier = window.recaptchaVerifier;
                firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
                    .then((confirmationResult) => {
                        alert('Verification code sent to your phone!');
                        window.confirmationResult = confirmationResult;
                        document.getElementById('phone-verification-code-group').style.display = 'flex';
                    }).catch((error) => {
                        alert('Error sending verification code: ' + error.message);
                        appVerifier.render().then(widgetId => recaptcha.reset(widgetId));
                    });
            });

            const submitCodeButton = document.getElementById('submit-verification-code');
            submitCodeButton.addEventListener('click', () => {
                const code = document.getElementById('phone-verification-code').value;
                if (!code) {
                    alert('Please enter the verification code.');
                    return;
                }
                window.confirmationResult.confirm(code).then((result) => {
                    const user = result.user;
                    user.getIdToken().then(idToken => {
                        fetch('{% url "verify_phone_token" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ token: idToken })
                        }).then(response => response.json())
                          .then(data => {
                              if (data.success) {
                                  alert('Phone number verified successfully!');
                                  window.location.reload();
                              } else {
                                  alert('Backend verification failed: ' + data.error);
                              }
                          });
                    });
                }).catch((error) => {
                    alert('Invalid verification code.');
                });
            });
        }
    });
</script>
{% endblock %}
