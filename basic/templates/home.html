{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<style>
    #friend-circle-container {
        position: relative;
        width: 600px;
        height: 600px;
        margin: 50px auto;
        border: 2px solid #ccc;
        border-radius: 50%;
    }
    .circle-orbit {
        position: absolute;
        border: 1px dashed #aaa;
        border-radius: 50%;
        top: 50%;
        left: 50%;
    }
    .user-node {
        position: absolute;
        width: 60px;
        height: 60px;
        background-color: #a2c4c9;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 10px;
        cursor: pointer;
        transition: transform 0.2s;
        overflow: hidden;
        padding: 5px;
        text-decoration: none;
    }
    .user-node:hover {
        transform: scale(1.1);
        z-index: 1000;
    }
    .user-node.center-user {
        width: 80px;
        height: 80px;
        background-color: #4a7c59;
        font-size: 14px;
        z-index: 100;
    }
    .recent-chats { margin: 20px auto; max-width: 800px; }
    .chat-link {
        display: block;
        padding: 10px;
        border: 1px solid #eee;
        margin-bottom: 5px;
        text-decoration: none;
        color: #333;
        border-radius: 5px;
    }
    .chat-link:hover { background-color: #f9f9f9; }
    .search-form { margin: 20px auto; max-width: 800px; display: flex; }
    .search-form input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .search-form button { padding: 10px 20px; margin-left: 10px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
</style>

<h1>Your Social Circle</h1>

<div id="friend-circle-container">
    <!-- Orbits and user nodes will be injected here by JavaScript -->
</div>

<hr>

<div class="recent-chats">
    <h2>Recent Chats</h2>
    {% for conv in recent_conversations %}
        <a href="{% url 'chat_view' conv.id %}" class="chat-link">
            Chat for task: <strong>{{ conv.task.title }}</strong>
        </a>
    {% empty %}
        <p>No recent conversations. Take a task to start chatting!</p>
    {% endfor %}
</div>

<hr>

<h2>Available Tasks</h2>

<form method="get" action="{% url 'home' %}" class="search-form">
    <input type="text" name="q" value="{{ search_query|default_if_none:'' }}" placeholder="Search for tasks...">
    <button type="submit">Search</button>
</form>

{% for task in tasks %}
    <div>
        <h3>{{ task.title }}</h3>
        <p>{{ task.description }}</p>
        <p><b>Reward:</b> {{ task.reward }} points</p>
        <p><i>Posted by: {{ task.posted_by.username }}</i></p>
        <a href="{% url 'take_task' task.id %}"><button>Take Task</button></a>
        <hr>
    </div>
{% empty %}
    <p>No tasks available matching your search.</p>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('friend-circle-container');
    const userNodesData = JSON.parse('{{ user_nodes_json|escapejs }}');
    const currentUser = {
        id: {{ request.user.id }},
        username: '{{ request.user.username }}',
        closeness: 101 // Center
    };

    const circles = {
        c1: { radius: 100, nodes: [], orbitSize: 200 },
        c2: { radius: 175, nodes: [], orbitSize: 350 },
        c3: { radius: 250, nodes: [], orbitSize: 500 },
        c4: { radius: 300, nodes: [], orbitSize: 600 }
    };

    for (const key in circles) {
        const orbit = document.createElement('div');
        orbit.className = 'circle-orbit';
        orbit.style.width = `${circles[key].orbitSize}px`;
        orbit.style.height = `${circles[key].orbitSize}px`;
        orbit.style.transform = `translate(-50%, -50%)`;
        container.appendChild(orbit);
    }

    userNodesData.forEach(node => {
        if (node.closeness > 75) circles.c1.nodes.push(node);
        else if (node.closeness > 50) circles.c2.nodes.push(node);
        else if (node.closeness > 25) circles.c3.nodes.push(node);
        else if (node.closeness >= 0) circles.c4.nodes.push(node);
    });

    const placeNodes = (nodes, radius) => {
        const angleStep = nodes.length > 1 ? (2 * Math.PI) / nodes.length : 0;
        nodes.forEach((node, index) => {
            const angle = index * angleStep;
            const x = container.offsetWidth / 2 + radius * Math.cos(angle) - 30;
            const y = container.offsetHeight / 2 + radius * Math.sin(angle) - 30;

            const nodeElement = document.createElement('a');
            nodeElement.className = 'user-node';
            nodeElement.href = `/user/${node.id}/`;
            nodeElement.style.left = `${x}px`;
            nodeElement.style.top = `${y}px`;
            nodeElement.textContent = node.username.split('@')[0];
            nodeElement.title = `${node.username} (Closeness: ${node.closeness})`;

            container.appendChild(nodeElement);
        });
    };

    const centerNode = document.createElement('a');
    centerNode.className = 'user-node center-user';
    centerNode.href = `{% url 'profile' %}`;
    centerNode.style.left = `50%`;
    centerNode.style.top = `50%`;
    centerNode.style.transform = `translate(-50%, -50%)`;
    centerNode.textContent = currentUser.username.split('@')[0];
    centerNode.title = 'Your Profile';
    container.appendChild(centerNode);

    for (const key in circles) {
        if (circles[key].nodes.length > 0) {
            placeNodes(circles[key].nodes, circles[key].radius);
        }
    }
});
</script>

{% endblock %}
