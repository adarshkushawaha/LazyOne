{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left Column -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Social Circle Section -->
        <div>
            {% if request.user.is_authenticated %}
                <h1 class="text-3xl font-bold text-white mb-4">Your Social Circle</h1>
                <div id="friend-circle-container" class="relative w-full max-w-xl mx-auto aspect-square rounded-full bg-gray-800/50 border border-gray-700/50 shadow-2xl flex items-center justify-center">
                    <!-- JS will inject nodes here -->
                </div>
            {% else %}
                <div class="text-center p-8">
                    <h1 class="text-3xl font-bold text-white">Welcome to LazyOne</h1>
                    <p class="text-gray-400 mt-2">Please <a href="{% url 'login_page' %}" class="text-cyan-400 font-bold hover:underline">login</a> to see your social circle and interact with tasks.</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Tasks Section -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">Recent Tasks</h2>
            <form method="get" action="{% url 'home' %}" class="mb-6">
                <input type="text" name="q" value="{{ search_query|default_if_none:'' }}" placeholder="Search for tasks..." class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-shadow duration-200">
            </form>

            <div class="space-y-4">
                {% for task in recent_tasks %}
                    <div class="scroll-animate bg-gray-800/50 border border-gray-700/50 rounded-xl p-5 transition-all duration-300 hover:shadow-cyan-500/20 hover:shadow-lg hover:border-cyan-500/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-white">{{ task.title }}</h3>
                                <p class="text-sm text-gray-400 mt-1">Posted by: {% if task.posted_by %}{{ task.posted_by.username }}{% else %}an anonymous user{% endif %}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="text-xl font-semibold text-cyan-400">{{ task.reward }}</p>
                                <p class="text-xs text-gray-500">Points</p>
                            </div>
                        </div>
                        <p class="text-gray-300 mt-3">{{ task.description }}</p>

                        {% if task.is_taken %}
                            <p class="text-sm text-amber-400 mt-3"><i>Taken by: {% if task.taken_by %}{{ task.taken_by.username }}{% else %}an anonymous user{% endif %}</i></p>
                        {% endif %}

                        <div class="mt-4">
                            {% if task.is_taken %}
                                {% if request.user.is_authenticated %}
                                    {% if request.user == task.posted_by or request.user == task.taken_by %}
                                        {% if task.conversation_id %}
                                            <a href="{% url 'chat_view' task.conversation_id %}" class="inline-block bg-cyan-500/80 text-white font-semibold px-5 py-2 rounded-lg hover:bg-cyan-500 transition-colors">Chat</a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if request.user.is_authenticated %}
                                    <a href="{% url 'take_task' task.id %}" class="inline-block bg-teal-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-teal-600 transition-colors">Take Task</a>
                                {% else %}
                                    <a href="{% url 'login_page' %}" class="inline-block bg-gray-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-gray-500 transition-colors">Login to Take Task</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="scroll-animate bg-gray-800/50 border border-gray-700/50 rounded-xl p-8 text-center">
                        <p class="text-gray-400">No tasks available at the moment.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="lg:col-span-1 space-y-8">
        {% if request.user.is_authenticated %}
            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Recent Chats</h2>
                <div class="space-y-3">
                    {% for conv in recent_conversations %}
                        <a href="{% url 'chat_view' conv.id %}" class="scroll-animate block bg-gray-800/50 border border-gray-700/50 rounded-xl p-4 hover:bg-gray-700/50 transition-colors">
                            {% if conv.task %}
                                <p class="text-sm text-gray-400">Task Chat</p>
                                <strong class="text-white">{{ conv.task.title }}</strong>
                            {% else %}
                                {% for participant in conv.participants.all %}
                                    {% if participant.id != request.user.id %}
                                        <p class="text-sm text-gray-400">Direct Chat</p>
                                        <strong class="text-white">{{ participant.username }}</strong>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </a>
                    {% empty %}
                        <div class="scroll-animate bg-gray-800/50 border border-gray-700/50 rounded-xl p-8 text-center">
                            <p class="text-gray-400">No recent conversations.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

</div>

<!-- Context Menu (hidden by default) -->
<div id="context-menu" class="context-menu fixed hidden bg-gray-800/90 backdrop-blur-md border border-gray-700 rounded-lg shadow-2xl py-2 z-50">
    <!-- JS will inject links here -->
</div>

<style>
    .circle-orbit {
        position: absolute;
        border: 1px dashed #4a5568; /* gray-600 */
        border-radius: 50%;
        top: 50%;
        left: 50%;
    }
    .user-node {
        position: absolute;
        width: 60px;
        height: 60px;
        background-color: #0d9488; /* teal-600 */
        color: white;
        border-radius: 50%;
        border: 3px solid #1a202c; /* page background */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        overflow: hidden;
        padding: 5px;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }
    .user-node:hover {
        transform: scale(1.15);
        z-index: 1000;
        border-color: #2dd4bf; /* cyan-400 */
    }
    .user-node.center-user {
        width: 80px;
        height: 80px;
        background-color: #0f766e; /* teal-700 */
        font-size: 14px;
        z-index: 100;
        border-width: 4px;
    }
    .scroll-animate {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .scroll-animate.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Scroll Animation
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    const elementsToAnimate = document.querySelectorAll('.scroll-animate');
    elementsToAnimate.forEach(el => observer.observe(el));

    // Friend Circle Logic
    const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
    if (!isAuthenticated) return;

    const container = document.getElementById('friend-circle-container');
    const userNodesData = JSON.parse('{{ user_nodes_json|escapejs }}');
    const currentUser = {
        id: {{ request.user.id }},
        username: '{{ request.user.username }}',
        closeness: 101 // Center
    };

    const contextMenu = document.getElementById('context-menu');

    window.addEventListener('click', () => {
        if (contextMenu.style.display === 'block') {
            contextMenu.style.display = 'none';
        }
    });

    const circles = {
        c1: { radius: 100, nodes: [], orbitSize: 200 },
        c2: { radius: 175, nodes: [], orbitSize: 350 },
        c3: { radius: 250, nodes: [], orbitSize: 500 },
        c4: { radius: 300, nodes: [], orbitSize: 600 }
    };

    for (const key in circles) {
        const orbit = document.createElement('div');
        orbit.className = 'circle-orbit';
        orbit.style.width = `${circles[key].orbitSize}px`;
        orbit.style.height = `${circles[key].orbitSize}px`;
        orbit.style.transform = `translate(-50%, -50%)`;
        container.appendChild(orbit);
    }

    userNodesData.forEach(node => {
        if (node.closeness > 75) circles.c1.nodes.push(node);
        else if (node.closeness > 50) circles.c2.nodes.push(node);
        else if (node.closeness > 25) circles.c3.nodes.push(node);
        else if (node.closeness >= 0) circles.c4.nodes.push(node);
    });

    const placeNodes = (nodes, radius) => {
        const angleStep = nodes.length > 1 ? (2 * Math.PI) / nodes.length : 0;
        nodes.forEach((node, index) => {
            const angle = index * angleStep;
            const x = container.offsetWidth / 2 + radius * Math.cos(angle) - 30;
            const y = container.offsetHeight / 2 + radius * Math.sin(angle) - 30;

            const nodeElement = document.createElement('div');
            nodeElement.className = 'user-node';
            nodeElement.style.left = `${x}px`;
            nodeElement.style.top = `${y}px`;
            nodeElement.textContent = node.username.split('@')[0];
            nodeElement.title = `${node.username} (Closeness: ${node.closeness})`;

            nodeElement.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                let menuContent = `<a href="/user/${node.id}/" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">See Profile</a>`;
                menuContent += `<a href="/chat/start/${node.id}/" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Chat</a>`;

                if (node.is_phone_verified && node.phone) {
                    menuContent += `<a href="https://wa.me/${node.phone}" target="_blank" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Chat with WhatsApp</a>`;
                }

                contextMenu.innerHTML = menuContent;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.display = 'block';
            });

            container.appendChild(nodeElement);
        });
    };

    const centerNode = document.createElement('a');
    centerNode.className = 'user-node center-user';
    centerNode.href = `{% url 'profile' %}`;
    centerNode.style.left = `50%`;
    centerNode.style.top = `50%`;
    centerNode.style.transform = `translate(-50%, -50%)`;
    centerNode.textContent = currentUser.username.split('@')[0];
    centerNode.title = 'Your Profile';
    container.appendChild(centerNode);

    for (const key in circles) {
        if (circles[key].nodes.length > 0) {
            placeNodes(circles[key].nodes, circles[key].radius);
        }
    }
});
</script>

{% endblock %}